"use strict"
Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"})
const e=require("http-errors"),t=require("js-yaml"),r=require("semver"),n=require("node:fs"),o=require("node:path"),a=require("@liquid-labs/http-smart-response"),i=require("@liquid-labs/shell-toolkit"),u=require("@liquid-labs/liq-handlers-lib")
function c(e){const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}})
if(e)for(const r in e)if("default"!==r){const n=Object.getOwnPropertyDescriptor(e,r)
Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:()=>e[r]})}return t.default=e,Object.freeze(t)}const s=c(r),l=c(n),p=c(o)
function f(e,t,r,n,o,a,i){try{var u=e[a](i),c=u.value}catch(e){return void r(e)}u.done?t(c):Promise.resolve(c).then(n,o)}function d(e){return function(){var t=this,r=arguments
return new Promise((function(n,o){var a=e.apply(t,r)
function i(e){f(a,n,o,i,u,"next",e)}function u(e){f(a,n,o,i,u,"throw",e)}i(void 0)}))}}function h(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var m={exports:{}},v={exports:{}}
!function(e){function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}(v)
var y=v.exports
!function(e){var t=y.default
function r(){e.exports=r=function(){return n},e.exports.__esModule=!0,e.exports.default=e.exports
var n={},o=Object.prototype,a=o.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},u="function"==typeof Symbol?Symbol:{},c=u.iterator||"@@iterator",s=u.asyncIterator||"@@asyncIterator",l=u.toStringTag||"@@toStringTag"
function p(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{p({},"")}catch(e){p=function(e,t,r){return e[t]=r}}function f(e,t,r,n){var o=t&&t.prototype instanceof m?t:m,a=Object.create(o.prototype),u=new E(n||[])
return i(a,"_invoke",{value:j(e,r,u)}),a}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}n.wrap=f
var h={}
function m(){}function v(){}function y(){}var g={}
p(g,c,(function(){return this}))
var b=Object.getPrototypeOf,x=b&&b(b(N([])))
x&&x!==o&&a.call(x,c)&&(g=x)
var w=y.prototype=m.prototype=Object.create(g)
function O(e){["next","throw","return"].forEach((function(t){p(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,r){function n(o,i,u,c){var s=d(e[o],e,i)
if("throw"!==s.type){var l=s.arg,p=l.value
return p&&"object"==t(p)&&a.call(p,"__await")?r.resolve(p.__await).then((function(e){n("next",e,u,c)}),(function(e){n("throw",e,u,c)})):r.resolve(p).then((function(e){l.value=e,u(l)}),(function(e){return n("throw",e,u,c)}))}c(s.arg)}var o
i(this,"_invoke",{value:function(e,t){function a(){return new r((function(r,o){n(e,t,r,o)}))}return o=o?o.then(a,a):a()}})}function j(e,t,r){var n="suspendedStart"
return function(o,a){if("executing"===n)throw new Error("Generator is already running")
if("completed"===n){if("throw"===o)throw a
return q()}for(r.method=o,r.arg=a;;){var i=r.delegate
if(i){var u=k(i,r)
if(u){if(u===h)continue
return u}}if("next"===r.method)r.sent=r._sent=r.arg
else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg
r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg)
n="executing"
var c=d(e,t,r)
if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===h)continue
return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function k(e,t){var r=t.method,n=e.iterator[r]
if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h
var o=d(n,e.iterator,t.arg)
if("throw"===o.type)return t.method="throw",t.arg=o.arg,t.delegate=null,h
var a=o.arg
return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function P(e){var t={tryLoc:e[0]}
1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function _(e){var t=e.completion||{}
t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function N(e){if(e){var t=e[c]
if(t)return t.call(e)
if("function"==typeof e.next)return e
if(!isNaN(e.length)){var r=-1,n=function t(){for(;++r<e.length;)if(a.call(e,r))return t.value=e[r],t.done=!1,t
return t.value=void 0,t.done=!0,t}
return n.next=n}}return{next:q}}function q(){return{value:void 0,done:!0}}return v.prototype=y,i(w,"constructor",{value:y,configurable:!0}),i(y,"constructor",{value:v,configurable:!0}),v.displayName=p(y,l,"GeneratorFunction"),n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor
return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,p(e,l,"GeneratorFunction")),e.prototype=Object.create(w),e},n.awrap=function(e){return{__await:e}},O(S.prototype),p(S.prototype,s,(function(){return this})),n.AsyncIterator=S,n.async=function(e,t,r,o,a){void 0===a&&(a=Promise)
var i=new S(f(e,t,r,o),a)
return n.isGeneratorFunction(t)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},O(w),p(w,l,"Generator"),p(w,c,(function(){return this})),p(w,"toString",(function(){return"[object Generator]"})),n.keys=function(e){var t=Object(e),r=[]
for(var n in t)r.push(n)
return r.reverse(),function e(){for(;r.length;){var n=r.pop()
if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},n.values=N,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0
var e=this.tryEntries[0].completion
if("throw"===e.type)throw e.arg
return this.rval},dispatchException:function(e){if(this.done)throw e
var t=this
function r(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],i=o.completion
if("root"===o.tryLoc)return r("end")
if(o.tryLoc<=this.prev){var u=a.call(o,"catchLoc"),c=a.call(o,"finallyLoc")
if(u&&c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)
if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally")
if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r]
if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n
break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null)
var i=o?o.completion:{}
return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg
return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t]
if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),_(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t]
if(r.tryLoc===e){var n=r.completion
if("throw"===n.type){var o=n.arg
_(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:N(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},n}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports}(m)
var g=(0,m.exports)(),b=g
try{regeneratorRuntime=g}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=g:Function("r","regeneratorRuntime = r")(g)}const x=h(b)
function w(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]
if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return
if("string"==typeof e)return O(e,t)
var r=Object.prototype.toString.call(e).slice(8,-1)
"Object"===r&&e.constructor&&(r=e.constructor.name)
if("Map"===r||"Set"===r)return Array.from(e)
if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return O(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r)
var n=0,o=function(){}
return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,u=!1
return{s:function(){r=r.call(e)},n:function(){var e=r.next()
return i=e.done,e},e:function(e){u=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(u)throw a}}}}function O(e,t){(null==t||t>e.length)&&(t=e.length)
for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r]
return n}var S="liquid-labs/liq-core:registry-data",j=function(){var r=d(x.mark((function r(n){var o,a,i,u,c,s,l,p,f,d,h,m,v,y
return x.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o=n.cache,a=n.registries,i=void 0===a?[]:a,u=n.update,void 0!==(c=o.get(S))&&!0!==u){r.next=48
break}s={},l=w(i),r.prev=5,l.s()
case 7:if((p=l.n()).done){r.next=36
break}return h=p.value.url,m=void 0,r.prev=10,r.next=13,fetch("https://"+h)
case 13:return v=r.sent,r.next=16,v.text()
case 16:m=r.sent,r.next=22
break
case 19:throw r.prev=19,r.t0=r.catch(10),e.InternalServerError("Could not load registry data.",{cause:r.t0})
case 22:y=void 0,r.prev=23,y=h.endsWith(".yaml")?t.load(m):JSON.parse(m),r.next=30
break
case 27:throw r.prev=27,r.t1=r.catch(23),e.BadRequest("Registry at https://".concat(h," does not parse as ").concat(h.endsWith(".yaml")?"YAML":"JSON","."),{cause:r.t1})
case 30:if(void 0!==(null===(f=y)||void 0===f||null===(d=f.meta)||void 0===d?void 0:d.id)){r.next=33
break}throw e.BadRequest("Registry at https://".concat(h," does not define 'meta.id'."))
case 33:s[y.meta.id]=y
case 34:r.next=7
break
case 36:r.next=41
break
case 38:r.prev=38,r.t2=r.catch(5),l.e(r.t2)
case 41:return r.prev=41,l.f(),r.finish(41)
case 44:return o.put(S,s),r.abrupt("return",s)
case 48:return r.abrupt("return",c)
case 49:case"end":return r.stop()}}),r,null,[[5,38,41,44],[10,19],[23,27]])})))
return function(e){return r.apply(this,arguments)}}()
function k(e,t){(null==t||t>e.length)&&(t=e.length)
for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r]
return n}function P(e,t){if(e){if("string"==typeof e)return k(e,t)
var r=Object.prototype.toString.call(e).slice(8,-1)
return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?k(e,t):void 0}}function _(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]
if(null!=r){var n,o,a,i,u=[],c=!0,s=!1
try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return
c=!1}else for(;!(c=(n=a.call(r)).done)&&(u.push(n.value),u.length!==t);c=!0);}catch(e){s=!0,o=e}finally{try{if(!c&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(s)throw o}}return u}}(e,t)||P(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]
if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return
if("string"==typeof e)return N(e,t)
var r=Object.prototype.toString.call(e).slice(8,-1)
"Object"===r&&e.constructor&&(r=e.constructor.name)
if("Map"===r||"Set"===r)return Array.from(e)
if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return N(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r)
var n=0,o=function(){}
return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,u=!1
return{s:function(){r=r.call(e)},n:function(){var e=r.next()
return i=e.done,e},e:function(e){u=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(u)throw a}}}}function N(e,t){(null==t||t>e.length)&&(t=e.length)
for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r]
return n}var q=function(e){var t=e.hostVersion,r=e.installedPlugins,n=e.pluginType,o=e.registryData
return Object.entries(o).reduce((function(e,o){var a,i=_(o,2),u=i[0],c=i[1],l=c.series.find((function(e){var r=e.versions
return s.satisfies(t,r,{includePrerelease:!0})})),p=E((null==l?void 0:l.plugins[n])||[])
try{for(p.s();!(a=p.n()).done;){var f=a.value
void 0!==r&&(f.installed=r.some((function(e){return e.npmName===c.npmName}))),f.source=u,e.push(f)}}catch(e){p.e(e)}finally{p.f()}return e}),[])}
function A(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]
if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return
if("string"==typeof e)return L(e,t)
var r=Object.prototype.toString.call(e).slice(8,-1)
"Object"===r&&e.constructor&&(r=e.constructor.name)
if("Map"===r||"Set"===r)return Array.from(e)
if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return L(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r)
var n=0,o=function(){}
return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,u=!1
return{s:function(){r=r.call(e)},n:function(){var e=r.next()
return i=e.done,e},e:function(e){u=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(u)throw a}}}}function L(e,t){(null==t||t>e.length)&&(t=e.length)
for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r]
return n}function T(e){return T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},T(e)}function R(e){var t=function(e,t){if("object"!==T(e)||null===e)return e
var r=e[Symbol.toPrimitive]
if(void 0!==r){var n=r.call(e,t||"default")
if("object"!==T(n))return n
throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string")
return"symbol"===T(t)?t:String(t)}function C(e,t,r){return(t=R(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function I(e){return function(e){if(Array.isArray(e))return k(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||P(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function F(e,t){var r=Object.keys(e)
if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e)
t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function D(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{}
t%2?F(Object(r),!0).forEach((function(t){C(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):F(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var M=["name","npmName","installed","summary","handlerCount","provider","homepage"],G=function(e){var t=e.homepageClose,r=void 0===t?"":t,n=e.homepageOpen,o=void 0===n?"":n,a=e.installedClose,i=void 0===a?"":a,u=e.installedOpen,c=void 0===u?"":u,s=e.nameClose,l=void 0===s?"":s,p=e.nameOpen,f=void 0===p?"":p,d=e.p,h=e.providerClose,m=void 0===h?"":h,v=e.providerOpen,y=void 0===v?"":v,g="- ".concat(f).concat(d.name).concat(l)
return void 0!==d.provider&&(g+=" from ".concat(y).concat(d.provider).concat(m)),void 0===d.installed&&void 0===d.handlerCount||(g+=" (".concat(void 0!==d.installed?"".concat(c,"installed").concat(i)+(void 0!==d.handlerCount?"; ":""):"").concat(void 0!==d.handlerCount?"".concat(d.handlerCount," handlers"):"",")")),d.summary&&(g+=": ",g+=void 0!==d.summary?d.summary:""),void 0===d.npmName&&void 0===d.homepage||(g+="\n  ",g+=void 0!==d.npmName?"NPM: "+d.npmName+(void 0!==d.homepage?" ":""):"",g+=void 0!==d.homepage?"homepage: ".concat(o).concat(d.homepage).concat(r):""),g},V=function(e){var t=e.data,r=void 0===t?[]:t,n=e.title
return"# ".concat(n,"\n\n")+r.map((function(e){return G({homepageClose:"_",homepageOpen:"_",installedClose:"__",installedOpen:"__",nameClose:"___",nameOpen:"___",p:e,providerClose:"__",providerOpen:"__"})})).join("\n")},Y=function(e){var t=e.data
return(void 0===t?[]:t).map((function(e){return G({homepageClose:"<rst>",homepageOpen:"<code>",installedClose:"<rst>",installedOpen:"<em>",nameClose:"<rst>",nameOpen:"<h2>",p:e,providerClose:"<rst>",providerOpen:"<bold>"})})).join("\n")},B=function(e){var t=e.data
return(void 0===t?[]:t).map((function(e){return G({p:e})})).join("\n")},H=function(){var e=d(x.mark((function e(t){var r,n,o,a,i,u,c
return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.app,n=t.cache,o=t.hostVersion,a=t.installedPlugins,i=t.pluginType,u=t.update,e.next=3,j({cache:n,registries:r.liq.serverSettings.registries,update:u})
case 3:return c=e.sent,e.abrupt("return",q({hostVersion:o,installedPlugins:a,pluginType:i,registryData:c}))
case 5:case"end":return e.stop()}}),e)})))
return function(t){return e.apply(this,arguments)}}()
exports.REGISTRY_DATA_KEY=S,exports.addPluginsHandler=function(t){var r=t.hostVersionRetriever,n=t.installedPluginsRetriever,o=t.pluginPkgDirRetriever,u=t.pluginsDesc,c=t.pluginType,s=t.reloadFunc
return function(t){var f=t.app,h=t.cache,m=t.model,v=t.reporter
return function(){var t=d(x.mark((function t(d,y){var g,b,w,O,S,k,P,_,E,N,L,T,R,C,I,F,D
return x.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:g=n({app:f,model:m,reporter:v,req:d})||[],b=d.vars.npmNames,w=r({app:f,cache:h,model:m,reporter:v,req:d}),S=[],k=[],P=[],_=A(b),t.prev=7,N=x.mark((function t(){var r,n,o,a,i,u
return x.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=E.value,!0!==(n=g.some((function(e){return e.npmName===r})))){t.next=5
break}return S.push(r),t.abrupt("return","continue")
case 5:o=A(m.playground.projects.list({rawData:!0})),t.prev=6,o.s()
case 8:if((a=o.n()).done){t.next=16
break}if(u=a.value,r!==(null===(i=u.packageJSON)||void 0===i?void 0:i.name)){t.next=14
break}return k.push("file:"+u.localProjectPath),n=!0,t.abrupt("break",16)
case 14:t.next=8
break
case 16:t.next=21
break
case 18:t.prev=18,t.t0=t.catch(6),o.e(t.t0)
case 21:return t.prev=21,o.f(),t.finish(21)
case 24:if(!1!==n){t.next=35
break}if(t.t1=O,t.t1){t.next=30
break}return t.next=29,j({cache:h,registries:f.liq.serverSettings.registries})
case 29:t.t1=t.sent
case 30:if(O=t.t1,q({hostVersion:w,pluginType:c,registryData:O}).some((function(e){return e.npmName===r}))){t.next=34
break}throw e.NotFound("No such plugin package '".concat(r,"' found in the registries."))
case 34:P.push(r)
case 35:case"end":return t.stop()}}),t,null,[[6,18,21,24]])})),_.s()
case 10:if((E=_.n()).done){t.next=17
break}return t.delegateYield(N(),"t0",12)
case 12:if("continue"!==t.t0){t.next=15
break}return t.abrupt("continue",15)
case 15:t.next=10
break
case 17:t.next=22
break
case 19:t.prev=19,t.t1=t.catch(7),_.e(t.t1)
case 22:return t.prev=22,_.f(),t.finish(22)
case 25:if(L=P.length>0,T=k.length>0,C=((R=L||T)?"<em>Installed<rst> <code>"+(T?k.join("<rst>, <code>")+"<rst> development packages":L?" and <code>":"")+(L?P.join("<rst>, <code>")+"<rst> production packages":""):"Nothing installed")+(S.length>0?(R?"; <code>":"")+S.join("<rst>, <code>")+"<rst> packages already installed":""),I=o({app:f,model:m,reporter:v,req:d}),F=p.join(I,"package.json"),l.existsSync(F)||(l.mkdirSync(I,{recursive:!0}),l.writeFileSync(F,"{}")),!0!==R){t.next=42
break}if(i.tryExec('cd "'.concat(I,'" && npm install ').concat(P.join(" ")," ").concat(k.join(" "))),void 0===s){t.next=39
break}if(!(D=s({app:f,cache:h,model:m,reporter:v,req:d})).then){t.next=39
break}return t.next=39,D
case 39:C+="; ".concat(u," plugins reloaded."),t.next=43
break
case 42:C+="."
case 43:a.httpSmartResponse({msg:C,req:d,res:y})
case 44:case"end":return t.stop()}}),t,null,[[7,19,22,25]])})))
return function(e,r){return t.apply(this,arguments)}}()}},exports.addPluginsSetup=function(e){var t,r=e.hostVersionRetriever,n=e.pluginsDesc,o=e.pluginType,a={name:"add ".concat(n," plugins"),summary:"Installs one or more ".concat(n," plugins."),description:"Installs one or more ".concat(n," plugins.")},i=[{name:"npmNames",isMultivalue:!0,description:"The plugins to install, by their NPM package name. Include multiple times to install multiple plugins.",optionsFunc:(t=d(x.mark((function e(t){var n,a,i,u,c,s
return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.app,a=t.model,i=t.cache,u=r({app:n,model:a}),e.next=4,j({cache:i,registries:n.liq.serverSettings.registries})
case 4:return c=e.sent,s=q({hostVersion:u,pluginType:o,registryData:c}),e.abrupt("return",s.map((function(e){return e.npmName})))
case 7:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]
return{help:a,method:"put",parameters:i}},exports.detailsPluginHandler=function(t){var r=t.installedPluginsRetriever,n=t.nameKey
return function(t){var o=t.app
t.cache
var i=t.model
return t.reporter,function(){var t=d(x.mark((function t(u,c){var s,l,p
return x.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s=r({app:o,model:i,req:u}),l=u.vars[n],p=s.find((function(e){var t=e.name
return l===t}))){t.next=5
break}throw e.NotFound("No such plugin '".concat(l,"' found."))
case 5:a.httpSmartResponse({data:p,req:u,res:c})
case 6:case"end":return t.stop()}}),t)})))
return function(e,r){return t.apply(this,arguments)}}()}},exports.detailsPluginSetup=function(e){var t=e.pluginsDesc
return{help:{name:"".concat(t," plugins details"),summary:"Provides details on the named plugin.",description:"Provides details on the named plugin."},method:"get",parameters:[]}},exports.determineRegistryData=j,exports.listPluginsHandler=function(e){var t=e.hostVersionRetriever,r=e.installedPluginsRetriever,n=e.pluginType
return function(e){var o=e.app,a=e.cache,i=e.model,c=e.reporter
return function(){var e=d(x.mark((function e(s,l){var p,f,d,h,m,v,y
return x.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p=t({app:o,model:i}),f=r({app:o,model:i,req:s})||[],d=s.vars,h=d.available,m=d.update,v=!0===h?["name","summary","provider","homepage"]:["name","handlerCount","installed","summary","provider","homepage"],!0!==h){e.next=10
break}return e.next=7,H({app:o,cache:a,hostVersion:p,installedPlugins:f,pluginType:n,update:m})
case 7:e.t0=e.sent,e.next=11
break
case 10:e.t0=f.map((function(e){return{name:e.name,summary:e.summary,installed:!0}})).sort((function(e,t){return e.name.localeCompare(t.name)}))
case 11:y=e.t0,u.formatOutput(D({basicTitle:"Plugins Report",data:y,allFields:M,defaultFields:v,mdFormatter:V,terminalFormatter:Y,textFormatter:B,reporter:c,req:s,res:l},s.vars))
case 13:case"end":return e.stop()}}),e)})))
return function(t,r){return e.apply(this,arguments)}}()}},exports.listPluginsSetup=function(e){var t=e.pluginsDesc,r={name:"".concat(t," plugins list"),summary:"Lists the installed ".concat(t," plugins."),description:"Lists the installed ".concat(t," plugins.")},n=[{name:"available",isBoolean:!0,description:"Lists available plugins from registries rather than installed plugins."},{name:"update",isBoolean:!0,description:"Forces an update even if registry data is already cached."}].concat(I(u.commonOutputParams()))
return n.find((function(e){return"fields"===e.name})).optionsFunc=function(){return M},{help:r,method:"get",parameters:n}},exports.removePluginsHandler=function(t){var r=t.installedPluginsRetriever,n=t.nameKey,o=t.pluginPkgDirRetriever,u=t.reloadFunc
return function(t){var c=t.app,s=t.cache,l=t.model,p=t.reporter
return function(){var t=d(x.mark((function t(f,d){var h,m,v,y,g,b
return x.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(h=r({app:c,model:l,req:f}),m=f.vars[n],v=h.find((function(e){var t=e.name
return m===t}))){t.next=5
break}throw e.NotFound("No such plugin '".concat(m,"' found."))
case 5:if(y=v.npmName,g=o({app:c,model:l,reporter:p,req:f}),i.tryExec('cd "'.concat(g,'" && npm uninstall ').concat(y)),void 0===u){t.next=13
break}if(!(b=u({app:c,cache:s,model:l,reporter:p,req:f})).then){t.next=13
break}return t.next=13,b
case 13:a.httpSmartResponse({msg:"<em>Removed<rst> <code>".concat(m,"<rst> plugin. Server endpoints refreshed."),req:f,res:d})
case 14:case"end":return t.stop()}}),t)})))
return function(e,r){return t.apply(this,arguments)}}()}},exports.removePluginsSetup=function(e){var t=e.pluginsDesc
return{help:{name:"remove ".concat(t," plugins"),summary:"Removes the named plugin.",description:"Removes the named plugin."},method:"delete",parameters:[]}},exports.selectMatchingPlugins=q
//# sourceMappingURL=liq-plugins-lib.js.map
